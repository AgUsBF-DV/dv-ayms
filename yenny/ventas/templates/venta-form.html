{% extends "_base.html" %}

{% block content %}

    <section class="text-gray-900 bg-white dark:text-white dark:bg-gray-800 rounded-2xl max-w-xl mx-auto">
    <style>
    /* Oculta los botones de subir/bajar en inputs tipo number solo para los campos readonly */
    input[readonly][type=number]::-webkit-inner-spin-button,
    input[readonly][type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[readonly][type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
    </style>
        <div class="py-8 px-4 mx-auto max-w-lg">

            <h2 class="mb-6 text-xl text-center font-bold text-gray-900 dark:text-white">Registrar una nueva venta</h2>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                <div class="flex flex-col mb-4">
                    <div class="flex flex-col justify-center mb-4">
                        <label for="cliente" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Cliente</label>
                        {{ form.cliente }}
                    </div>
                </div>

                <div class="mb-6">

                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Libros vendidos</h3>

                    <div id="venta-libros-list" class="mb-4">
                        <!-- Aquí se debe renderizar dinámicamente los campos de la tabla pivot: libro, cantidad, precio unitario, subtotal -->
                        <!-- Ejemplo de fila, para implementar con JS o Django formsets -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block mb-2 text-xs font-medium text-gray-700 dark:text-white">Libro</label>
                                <select name="libro" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="" selected disabled>Seleccione el libro</option>
                                    {% for libro in libros %}
                                        <option value="{{ libro.id }}" data-precio="{{ libro.precio }}">{{ libro.titulo }} ({{ libro.autor }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block mb-2 text-xs font-medium text-gray-700 dark:text-white">Cantidad</label>
                                <input type="number" name="cantidad" min="1" value="1" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>

                            <div>
                                <label class="block mb-2 text-xs font-medium text-gray-700 dark:text-white">Precio unitario</label>
                                <input type="number" name="precio_unitario" step="0.01" readonly class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>

                            <div>
                                <label class="block mb-2 text-xs font-medium text-gray-700 dark:text-white">Subtotal</label>
                                <input type="number" name="subtotal" step="0.01" readonly class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            </div>
                        </div>

                        <!-- Botón para agregar más filas -->
                        <button type="button" class="mt-2 px-3 py-2 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                            Agregar libro
                        </button>

                    </div>
                </div>

                <div class="flex flex-col justify-center mb-4">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Total de la venta</label>
                    <input type="number" name="total" id="total-venta" readonly class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                </div>
 
                <script>
                // JS para manejo dinámico de libros, precios y totales
                document.addEventListener('DOMContentLoaded', function() {
                    function updateRow(row) {
                        const libroSelect = row.querySelector('select[name="libro"]');
                        const cantidadInput = row.querySelector('input[name="cantidad"]');
                        const precioInput = row.querySelector('input[name="precio_unitario"]');
                        const subtotalInput = row.querySelector('input[name="subtotal"]');

                        // Al cambiar libro, actualizar precio unitario
                        libroSelect.addEventListener('change', function() {
                            const selected = libroSelect.options[libroSelect.selectedIndex];
                            const precio = selected.getAttribute('data-precio') || 0;
                            precioInput.value = precio;
                            precioInput.setAttribute('readonly', true);
                            calcularSubtotal();
                        });

                        // Al cambiar cantidad, recalcular subtotal
                        cantidadInput.addEventListener('input', calcularSubtotal);

                        function calcularSubtotal() {
                            const cantidad = parseInt(cantidadInput.value) || 0;
                            const precio = parseFloat(precioInput.value) || 0;
                            const subtotal = cantidad * precio;
                            subtotalInput.value = subtotal.toFixed(2);
                            subtotalInput.setAttribute('readonly', true);
                            calcularTotal();
                        }
                    }

                    function calcularTotal() {
                        let total = 0;
                        document.querySelectorAll('#venta-libros-list input[name="subtotal"]').forEach(function(input) {
                            total += parseFloat(input.value) || 0;
                        });
                        document.getElementById('total-venta').value = total.toFixed(2);
                    }

                    // Inicializar la primera fila
                    const firstRow = document.querySelector('#venta-libros-list .grid');
                    if (firstRow) updateRow(firstRow);

                    // Agregar nuevas filas dinámicamente
                    document.querySelector('#venta-libros-list button').addEventListener('click', function() {
                        const row = firstRow.cloneNode(true);
                        
                        // Limpiar valores
                        row.querySelector('select[name="libro"]').selectedIndex = 0;
                        row.querySelector('input[name="cantidad"]').value = 1;
                        row.querySelector('input[name="precio_unitario"]').value = '';
                        row.querySelector('input[name="subtotal"]').value = '';
                        document.getElementById('venta-libros-list').insertBefore(row, this);
                        updateRow(row);
                    });
                });
                </script>

                <div class="flex justify-center">
                    <button type="submit"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                        Registrar Venta
                    </button>
                </div>
            </form>
        </div>
    </section>

{% endblock content %}
